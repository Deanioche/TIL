# Transaction

## **목차**

1. 트랜잭션의 이해
2. 트랜젝션의 동시성
3. 트랙젝션의 특성

## 데이터 동시 접근의 문제

1. 동일 데이터에 다수 접근시 일관성 훼손


## 트랜젝션의 개념

1. 데이터베이스를 조작하기 위한 하나의 논리적 단위를 이루는 일련의 연산의 집합.
    - 예) 예금 인출

2. 데이터베이스를 사용하여 처리하는 작업을 하나의 묶음으로 인식하여 묶음 단위로 실행되도록 정의한 개념.


## 트랜젝션의 특징

1. 다수의 연산을 구성된 트랜잭션이 사용자에게 단일작업처럼 다뤄지도록 ACID특징을 준수.

2. ACID 특성

    - 원자성(atomicity) : 하나의 트랜잭션에 포함된 모든 연산을 완전히 수행되거나 전혀 수행되지 않음.
    - 일관성(consistency) : 특정 트랜젝션이 수행되기 전과 후에 데이터베이스가 일관된 상태를 유지.
    - 고립성(isolation) : 특정 트랜젝션이 데이터베이스를 갱신하는 동안 다른 트랜젝션에 의해 방해받지 않음.
    - 지속성(durability) : 완료된 트랙젝션의 결과는 어떠한 시스템의 장애에도 데이터베이스에 반영되어야 함.

## 트랜젝션 읽기와 쓰기

1. 트랜젝션의 두 연산
    - Read(x) : DB에서 데이터 x를 읽고, 트랜젝션이 실해오디는 메모리의 변수 x에 값을 저장하는 연산.
    - write(x) : 트랜젝션이 실행되는 메모리에 있는 변수 x의 값을 DB에 저장하는 연산.
2. 계좌 A에서 B를 1,000원을 이체하는 트랜젝션
<img src="https://user-images.githubusercontent.com/66513003/117250743-a6a6e580-ae7e-11eb-87a8-ca5934c131a4.png" width="200">

## ACID 특성 유지
- 트랜젝션 도중에는 일관성이 훼손되지만 트랙젝션이 종료될 때엔 회복되어 일관성을 유지하게 됨.

## 트랜젝션 연산자
1. 트랜젝션의 연산
    - Read(x) : DB에서 데이터 x를 읽고, 트랙젝션이 실행되는 메모리의 변수x에 값을 저장하는 연산.
    - Write(x) : 트랜젝션이 실행되는 메모리에 있는 변수 x의 ㄱ밧을 DB에 저장하는 연산.

2. 트랜젝션 실행의 연산
    - Commit : 트랜젝션 연산에 의해 갱신된 데이터 항목의 값을 DB에 반영시키고 지속성을 확보하는 연산.
    - Rollback : 트랜젝션이 중단되기 이전까지 수행한 연산에 의해 갱신된 모든 데이터 항목의 값을 무효화하여 일관성을 확보하는 연산.

## 트랜젝션의 5가지 상태 변화
1. 동작 : 트랜젝션이 시작을 준비 또는 실행중인 상태.
2. 부분 커밋 : 마지막 연산을 실행한 직후의 상태.
3. 커밋 : 모든 실행이 성공적을 완료된 후의 상태.
4. 실패 : 실행이 정상적으로 진행될 수 없는 상태.
5. 중단 : 실행 실패로 롤백되고 시작 이전의 상태로 환원된 상태.

- 오류가 발생했을 때 데이터의 수정이 어디까지 반영되었는지, 이 과정을 재수행 해야하는지 하지 말아야 하는지 판단하기 위해.

<br>
<br>
<br>

# 트랜젝션의 동시성

- 동시성 고려
- 직렬 / 병렬 스케줄
- 충돌 동등 / 충돌 직렬성

## 동시성 고려
1. DBMS는 다수의 사용자가 DB를 공용으로 사용하기 위한 목적으로 도입.

2. 트랜젝션 동시 실행의 이점
    - 트랜젝션 처리율과 자원 이용률 향상
    - 트랙젝션의 대기 시간을 감소시킨다.
3. 다중 사용자 환경에서 트랜젝션의 동시 실행으로 데이터 갱신 시, 일관성 훼손 문제가 발생.
    - 하지만 일관성을 해치지 않는 범위에서 동시에 서로 다른 데이터를 사용한다면 문제가 발생하지 않는다.
4. 동시성 제어(concurrency control)
    - 다수의 트랜젝션이 성공적으로 동시에 실행되어도 일관성을 유지할 수 있도록 지원하는 기법.

### # 스케줄 (schedule)
- 다수의 트랜젝션에 포함된 연산의 실행 순서를 명시한 것.

## 직렬 스케줄
- 각 트랜젝션에 속한 모든 연산이 순차적으로 실행되는 스케줄

## 병렬 스케줄
- 하나의 트랜젝션이 완료되기 전에 다른 트랜젝션이 실행되는 스케줄.
- 병렬 스케중의 순설로 연산을 수행할 경우 일관성 훼손이 발생 가능.

## 직렬 가능 스케줄
- 복수개의 트랜젝션이 동시에 수행된 결과가 직렬 스케줄의 결과와 동일한 스케줄.

## 직렬 가능 스케줄의 정의
1. 트랜젝션 간 연산 순서를 교환하여 트랜젝션을 직렬 스케줄과 동등하게 변환이 가능한 스케줄
2. 사용된 Read와 Write 연산 교환 시 상황에 따라 실행 결과에 일관성이 훼손되는 현상(충돌)이 발생.
3. 연산 순서의 교환(단, 𝐼𝑖는 𝑇𝑖의 연산)
<img src="https://user-images.githubusercontent.com/66513003/117254025-dfe15480-ae82-11eb-81f7-815fcf366be7.png" width="400">

## 충돌 동등
1. 특정 스케줄 𝑆에서 충돌이 일어나지 않는 연산의 순서를 바꿔 스케줄 𝑆′으로 변환이 가능한 상태.

## 충돌 직렬성
1. 순서 교환이 가능한 연산을 교환하여 직렬 스케줄의 연산과 동등하게 변환이 가능한 스케줄

<br>
<br>
<br>

# 트랜젝션의 회복

- 회복의 개념
- 회복 가능한 스케줄
- 비연쇄적 스케줄

## 회복의 개념
1. 원자성을 보장하기 위해 트랜젝션 실패 시 실행된 모든 연산을 시행 이전 상태로 복원하는 기법
2. 회복 불가능한 스케줄
    - 𝑇6가 𝑇5가 기록한 A를 읽고 커밋한 상태
    - 커밋한 𝑇6는 롤백 불가능
<img src="https://user-images.githubusercontent.com/66513003/117258950-82500680-ae88-11eb-8ed0-c90027307b9c.png" width="400">

## 회복 가능한 스케줄
1. 𝑇𝑖와 𝑇𝑗에 대해 𝑇𝑖가 기록한 데이터를 𝑇𝑗가 읽을 때, 𝑇𝑖의 커밋이 𝑇𝑗보다 먼저 나타나는 스케줄.
2. 연쇄적 롤백 유발할 가능성이 있다.
- 𝑇7의 롤백으로 인하여 연쇄적으로 다른 트랜젝션도 롤백되는 현상.
- 대량의 연산을 유발.

<img src="https://user-images.githubusercontent.com/66513003/117259630-32be0a80-ae89-11eb-9b9b-aaead2d1206d.png
" width="400">
- Abort : 실패

## 비연쇄적 스케줄
1. 연쇄적 롤백으로 발생할 수 있는 대량의 회복 연산을 방지하기 위해 연쇄적이지 않은 스케줄로 구성된 스케줄.
2. 𝑇𝑖가 기록한 데이터를 읽을 때 𝑇𝑖의 커밋이 𝑇𝑗의 읽기 연산보다 먼저 나타나는 스케줄

<img src="https://user-images.githubusercontent.com/66513003/117259940-816ba480-ae89-11eb-85c8-aefaf79c78a1.png
" width="400">

<br>
<br>
<br>

# **연습문제**

- 아래 그림과 같이 시스템 오류 이후, 트랜잭션 T1에 대해, 실행 결과가 데이터베이스에 반영이 되었는지 확인하고, 반영이 되어있지 않았다면, T1를 재실행한다. 이는 트랜잭션의 어떤 특성을 만족시키기 위한 것인가?
<img src="https://user-images.githubusercontent.com/66513003/117260445-0d7dcc00-ae8a-11eb-9835-2a0c889721e7.png
" width="400">

1. 고립성
2. 일관성
3. 원자성
4. 지속성

답 : 4

<br>
<br>
<br>

# **정리하기**
- 트랜잭션은 데이터베이스를 조작하기 위한 하나의 논리적 작업 단위를 이루는 일련의 연산들의 집합으로 트랜잭션이 실행 중에 멈추거나 중단되지 않는 최소 작업 단위이다.

- 트랜잭션은 ACID 특성이라고 하는 원자성, 일관성, 고립성, 지속성이라는 특성을 갖고 있으며 DBMS는 트랜잭션의 ACID 특성을 만족시키기 위해 지속적으로 명령의 실행과 데이터의 상태를 모니터링한다.

- 데이터베이스에 접근 연산을 수행하는 트랜잭션은 트랜잭션 내부에 포함되는 연산의 실행 가능성 여부에 따라 동작, 부분 커밋, 실패, 중단, 커밋 등 다섯 가지 상태 중 하나에 있게 된다.

- 다수의 사용자가 접근하는 데이터베이스에서 동시에 동일한 데이터에 접근할 가능성이 있으며 이러한 상황에서 데이터베이스의 무결성을 보장하고, 트랜잭션의 일관성을 유지하기 위해서는 동시성 제어를 통해 다중 사용자 환경에서 데이터에 대한 접근과 갱신을 통제할 필요가 있다.

- 트랜잭션의 동시 실행 가능 여부를 판단하기 위해서는 해당 트랜잭션으로 작성되는 스케줄 내부에서 트랜잭션 간 연산 순서를 교환하여 트랜잭션을 직렬 스케줄과 동등하게 변환이 가능해야 한다.

- 트랜잭션의 원자성을 위해 트랜잭션이 시작된 이후 중간에 실패하는 경우 트랜잭션이 시작되기 전까지의 상태로 회복시켜야 한다. 이를 트랜잭션의 회복화라고 한다.

- 한 트랜잭션이 수정한 데이터를 다른 트랜잭션이 읽을 경우 데이터를 수정한 트랜잭션의 커밋이 데이터 읽기보다 먼저 실행되는 스케줄을 회복가능 스케줄이라고 한다.